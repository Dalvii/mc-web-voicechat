(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const c of r)if(c.type==="childList")for(const s of c.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&a(s)}).observe(document,{childList:!0,subtree:!0});function o(r){const c={};return r.integrity&&(c.integrity=r.integrity),r.referrerPolicy&&(c.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?c.credentials="include":r.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function a(r){if(r.ep)return;r.ep=!0;const c=o(r);fetch(r.href,c)}})();const e={ws:null,localStream:null,peers:{},audioNodes:{},positions:{},localPseudo:"",connected:!1,audioContext:null};function C(){if(!e.audioContext)return;const t=e.positions[e.localPseudo];if(t)for(const n in e.audioNodes){const o=e.audioNodes[n];if(!e.positions[n])continue;const a=e.positions[n],{volume:r,pan:c,angle:s}=O(t,a);if(o.gain.gain.value=r,o.panner.pan.value=c,o.filter){const l=Math.abs(s)/Math.PI,d=2e4,u=d+(2e3-d)*l;o.filter.frequency.value=u}}}function O(t,n,o=20){const a=n.x-t.x,r=n.y-t.y,c=n.z-t.z;let i=1-Math.sqrt(a*a+r*r+c*c)/o;i=Math.max(0,Math.min(1,i));const l=t.yaw*Math.PI/180,d=Math.cos(-l),f=Math.sin(-l),u=a*d-c*f,S=a*f+c*d,g=Math.atan2(-u,S);let y=g/(Math.PI/2);return y=Math.max(-1,Math.min(1,y)),{volume:i,pan:y,angle:g}}const v={iceServers:[]};function m(t){if(e.peers[t])return e.peers[t];const n=new RTCPeerConnection(v);return n.onicecandidate=o=>{o.candidate&&p({type:"candidate",from:e.localPseudo,to:t,payload:o.candidate})},n.ontrack=o=>{console.log("ontrack from",t);const a=o.streams[0];M(t,a)},e.localStream&&e.localStream.getTracks().forEach(o=>{n.addTrack(o,e.localStream)}),e.peers[t]=n,n}function M(t,n){if(!e.audioContext)return;let o=document.getElementById("audio-"+t);o||(o=document.createElement("audio"),o.id="audio-"+t,o.autoplay=!1,o.style.display="none",document.body.appendChild(o)),o.srcObject=n;const a=e.audioContext.createMediaStreamSource(n),r=e.audioContext.createStereoPanner(),c=e.audioContext.createGain(),s=e.audioContext.createBiquadFilter();s.type="lowpass",s.frequency.value=2e4,a.connect(r).connect(c).connect(s).connect(e.audioContext.destination),e.audioNodes[t]={source:a,panner:r,gain:c,filter:s},C()}function N(t){console.log("handleJoin from",t);const n=m(t);n.createOffer().then(o=>n.setLocalDescription(o)).then(()=>{n.localDescription&&p({type:"offer",from:e.localPseudo,to:t,payload:n.localDescription})}).catch(console.error)}function k(t,n){console.log("handleOffer from",t);const o=m(t);o.setRemoteDescription(n).then(()=>o.createAnswer()).then(a=>o.setLocalDescription(a)).then(()=>{o.localDescription&&p({type:"answer",from:e.localPseudo,to:t,payload:o.localDescription})}).catch(console.error)}function P(t,n){console.log("handleAnswer from",t),m(t).setRemoteDescription(n).catch(console.error)}function x(t,n){console.log("handleCandidate from",t),m(t).addIceCandidate(new RTCIceCandidate(n)).catch(console.error)}function E(t){e.ws=new WebSocket(t);let n;e.ws.onopen=()=>{console.log("Connecté au serveur WebSocket."),e.connected=!0;const o=document.getElementById("startAudioBtn");o&&(o.disabled=!1),n=setInterval(()=>{var a;((a=e.ws)==null?void 0:a.readyState)===WebSocket.OPEN&&e.ws.send(JSON.stringify({type:"ping"}))},2e4)},e.ws.onmessage=async o=>{var i;let a;try{a=JSON.parse(o.data)}catch{console.warn("Message non JSON :",o.data);return}const{type:r,from:c,to:s}=a;if(r==="spatial"&&a.targets&&a.targets.forEach(({player:l,volume:d,pan:f})=>{const u=e.audioNodes[l];u&&(u.gain.gain.value=d,u.panner.pan.value=f)}),!(s&&s!==e.localPseudo))switch(r){case"join":c&&N(c);break;case"offer":c&&a.payload&&k(c,a.payload);break;case"answer":c&&a.payload&&P(c,a.payload);break;case"candidate":c&&a.payload&&x(c,a.payload);break;case"ping":(i=e.ws)==null||i.send(JSON.stringify({type:"pong"}));break;default:console.warn("Type de message inconnu :",r)}},e.ws.onclose=()=>{console.log("Déconnecté du serveur WebSocket."),e.connected=!1,clearInterval(n)},e.ws.onerror=o=>{console.error("Erreur WebSocket :",o)}}function p(t){e.ws&&e.connected&&e.ws.send(JSON.stringify(t))}window.store=e;const h=document.getElementById("pseudo"),w=document.getElementById("connectBtn"),b=document.getElementById("startAudioBtn");w.onclick=()=>{var o;const t=h.value.trim();if(!t){alert("Veuillez saisir votre pseudo (le même que Minecraft).");return}e.localPseudo=t;const n=new AudioContext;(o=e.audioContext)==null||o.valueOf,e.audioContext=n,E("wss://"+window.location.host+"/ws"),setTimeout(()=>{p({type:"join",from:e.localPseudo,to:null,payload:{}})},500),w.disabled=!0,h.disabled=!0};b.onclick=async()=>{try{e.localStream=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1}),console.log("Micro capturé."),Object.keys(e.peers).forEach(t=>{const n=e.peers[t];e.localStream.getTracks().forEach(o=>{n.addTrack(o,e.localStream)})}),Object.keys(e.peers).forEach(t=>{const n=e.peers[t];n.createOffer().then(o=>n.setLocalDescription(o)).then(()=>{n.localDescription&&p({type:"offer",from:e.localPseudo,to:t,payload:n.localDescription})}).catch(console.error)}),b.disabled=!0}catch(t){console.error("Erreur getUserMedia :",t),alert("Impossible d'accéder au micro.")}};
