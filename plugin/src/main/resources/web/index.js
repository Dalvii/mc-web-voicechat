(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const c of document.querySelectorAll('link[rel="modulepreload"]'))r(c);new MutationObserver(c=>{for(const a of c)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function e(c){const a={};return c.integrity&&(a.integrity=c.integrity),c.referrerPolicy&&(a.referrerPolicy=c.referrerPolicy),c.crossOrigin==="use-credentials"?a.credentials="include":c.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(c){if(c.ep)return;c.ep=!0;const a=e(c);fetch(c.href,a)}})();const n={ws:null,localStream:null,peers:{},audioNodes:{},positions:{},localPseudo:"",connected:!1,audioContext:null};function M(t){const{player:o,payload:e}=t;!o||!e||(n.positions[o]={x:e.x,y:e.y,z:e.z,yaw:e.yaw,pitch:e.pitch},console.log("Position reçue pour",o,n.positions[o]),C())}function C(){if(!n.audioContext)return;const t=n.positions[n.localPseudo];if(t)for(const o in n.audioNodes){const e=n.audioNodes[o];if(!n.positions[o])continue;const r=n.positions[o],{volume:c,pan:a,angle:s}=x(t,r);if(e.gain.gain.value=c,e.panner.pan.value=a,e.filter){const u=Math.abs(s)/Math.PI,i=2e4,m=i+(2e3-i)*u;e.filter.frequency.value=m}}}function x(t,o,e=20){const r=o.x-t.x,c=o.y-t.y,a=o.z-t.z;let d=1-Math.sqrt(r*r+c*c+a*a)/e;d=Math.max(0,Math.min(1,d));const u=t.yaw*Math.PI/180,i=Math.cos(-u),p=Math.sin(-u),m=r*i-a*p,S=r*p+a*i,h=Math.atan2(-m,S);let y=h/(Math.PI/2);return y=Math.max(-1,Math.min(1,y)),{volume:d,pan:y,angle:h}}const P={iceServers:[]};function f(t){if(n.peers[t])return n.peers[t];const o=new RTCPeerConnection(P);return o.onicecandidate=e=>{e.candidate&&l({type:"candidate",from:n.localPseudo,to:t,payload:e.candidate})},o.ontrack=e=>{console.log("ontrack from",t);const r=e.streams[0];O(t,r)},n.localStream&&n.localStream.getTracks().forEach(e=>{o.addTrack(e,n.localStream)}),n.peers[t]=o,o}function O(t,o){if(!n.audioContext)return;let e=document.getElementById("audio-"+t);e||(e=document.createElement("audio"),e.id="audio-"+t,e.autoplay=!1,e.style.display="none",document.body.appendChild(e)),e.srcObject=o;const r=n.audioContext.createMediaStreamSource(o),c=n.audioContext.createStereoPanner(),a=n.audioContext.createGain(),s=n.audioContext.createBiquadFilter();s.type="lowpass",s.frequency.value=2e4,r.connect(c).connect(a).connect(s).connect(n.audioContext.destination),n.audioNodes[t]={source:r,panner:c,gain:a,filter:s},C()}function k(t){console.log("handleJoin from",t);const o=f(t);o.createOffer().then(e=>o.setLocalDescription(e)).then(()=>{o.localDescription&&l({type:"offer",from:n.localPseudo,to:t,payload:o.localDescription})}).catch(console.error)}function v(t,o){console.log("handleOffer from",t);const e=f(t);e.setRemoteDescription(o).then(()=>e.createAnswer()).then(r=>e.setLocalDescription(r)).then(()=>{e.localDescription&&l({type:"answer",from:n.localPseudo,to:t,payload:e.localDescription})}).catch(console.error)}function A(t,o){console.log("handleAnswer from",t),f(t).setRemoteDescription(o).catch(console.error)}function N(t,o){console.log("handleCandidate from",t),f(t).addIceCandidate(new RTCIceCandidate(o)).catch(console.error)}function B(t){n.ws=new WebSocket(t),n.ws.onopen=()=>{console.log("Connecté au serveur WebSocket."),n.connected=!0;const o=document.getElementById("startAudioBtn");o&&(o.disabled=!1)},n.ws.onmessage=async o=>{let e;try{e=JSON.parse(o.data)}catch{console.warn("Message non JSON :",o.data);return}const{type:r,from:c,to:a}=e;if(r==="pos"){M(e);return}if(!(a&&a!==n.localPseudo))switch(r){case"join":c&&k(c);break;case"offer":c&&e.payload&&v(c,e.payload);break;case"answer":c&&e.payload&&A(c,e.payload);break;case"candidate":c&&e.payload&&N(c,e.payload);break;default:console.warn("Type de message inconnu :",r)}},n.ws.onclose=()=>{console.log("Déconnecté du serveur WebSocket."),n.connected=!1},n.ws.onerror=o=>{console.error("Erreur WebSocket :",o)}}function l(t){n.ws&&n.connected&&n.ws.send(JSON.stringify(t))}window.store=n;const g=document.getElementById("pseudo"),w=document.getElementById("connectBtn"),b=document.getElementById("startAudioBtn");w.onclick=()=>{var e;const t=g.value.trim();if(!t){alert("Veuillez saisir votre pseudo (le même que Minecraft).");return}n.localPseudo=t;const o=new AudioContext;(e=n.audioContext)==null||e.valueOf,n.audioContext=o,B("wss://"+window.location.host),setTimeout(()=>{l({type:"join",from:n.localPseudo,to:null,payload:{}})},500),w.disabled=!0,g.disabled=!0};b.onclick=async()=>{try{n.localStream=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1}),console.log("Micro capturé."),Object.keys(n.peers).forEach(t=>{const o=n.peers[t];n.localStream.getTracks().forEach(e=>{o.addTrack(e,n.localStream)})}),Object.keys(n.peers).forEach(t=>{const o=n.peers[t];o.createOffer().then(e=>o.setLocalDescription(e)).then(()=>{o.localDescription&&l({type:"offer",from:n.localPseudo,to:t,payload:o.localDescription})}).catch(console.error)}),b.disabled=!0}catch(t){console.error("Erreur getUserMedia :",t),alert("Impossible d'accéder au micro.")}};
