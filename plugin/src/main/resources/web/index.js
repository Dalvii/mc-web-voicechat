(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))c(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&c(s)}).observe(document,{childList:!0,subtree:!0});function e(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function c(r){if(r.ep)return;r.ep=!0;const a=e(r);fetch(r.href,a)}})();const o={ws:null,localStream:null,peers:{},audioNodes:{},positions:{},localPseudo:"",connected:!1,audioContext:null};function M(t){const{player:n,payload:e}=t;!n||!e||(o.positions[n]={x:e.x,y:e.y,z:e.z,yaw:e.yaw,pitch:e.pitch},console.log("Position reçue pour",n,o.positions[n]),S())}function S(){if(!o.audioContext)return;const t=o.positions[o.localPseudo];if(t)for(const n in o.audioNodes){const e=o.audioNodes[n];if(!o.positions[n])continue;const c=o.positions[n],{volume:r,pan:a,angle:s}=O(t,c);if(e.gain.gain.value=r,e.panner.pan.value=a,e.filter){const u=Math.abs(s)/Math.PI,l=2e4,m=l+(2e3-l)*u;e.filter.frequency.value=m}}}function O(t,n,e=20){const c=n.x-t.x,r=n.y-t.y,a=n.z-t.z;let i=1-Math.sqrt(c*c+r*r+a*a)/e;i=Math.max(0,Math.min(1,i));const u=t.yaw*Math.PI/180,l=Math.cos(-u),p=Math.sin(-u),m=c*l-a*p,C=c*p+a*l,h=Math.atan2(-m,C);let y=h/(Math.PI/2);return y=Math.max(-1,Math.min(1,y)),{volume:i,pan:y,angle:h}}const P={iceServers:[]};function f(t){if(o.peers[t])return o.peers[t];const n=new RTCPeerConnection(P);return n.onicecandidate=e=>{e.candidate&&d({type:"candidate",from:o.localPseudo,to:t,payload:e.candidate})},n.ontrack=e=>{console.log("ontrack from",t);const c=e.streams[0];x(t,c)},o.localStream&&o.localStream.getTracks().forEach(e=>{n.addTrack(e,o.localStream)}),o.peers[t]=n,n}function x(t,n){if(!o.audioContext)return;let e=document.getElementById("audio-"+t);e||(e=document.createElement("audio"),e.id="audio-"+t,e.autoplay=!1,e.style.display="none",document.body.appendChild(e)),e.srcObject=n;const c=o.audioContext.createMediaStreamSource(n),r=o.audioContext.createStereoPanner(),a=o.audioContext.createGain(),s=o.audioContext.createBiquadFilter();s.type="lowpass",s.frequency.value=2e4,c.connect(r).connect(a).connect(s).connect(o.audioContext.destination),o.audioNodes[t]={source:c,panner:r,gain:a,filter:s},S()}function v(t){console.log("handleJoin from",t);const n=f(t);n.createOffer().then(e=>n.setLocalDescription(e)).then(()=>{n.localDescription&&d({type:"offer",from:o.localPseudo,to:t,payload:n.localDescription})}).catch(console.error)}function k(t,n){console.log("handleOffer from",t);const e=f(t);e.setRemoteDescription(n).then(()=>e.createAnswer()).then(c=>e.setLocalDescription(c)).then(()=>{e.localDescription&&d({type:"answer",from:o.localPseudo,to:t,payload:e.localDescription})}).catch(console.error)}function N(t,n){console.log("handleAnswer from",t),f(t).setRemoteDescription(n).catch(console.error)}function A(t,n){console.log("handleCandidate from",t),f(t).addIceCandidate(new RTCIceCandidate(n)).catch(console.error)}function E(t){o.ws=new WebSocket(t);let n;o.ws.onopen=()=>{console.log("Connecté au serveur WebSocket."),o.connected=!0;const e=document.getElementById("startAudioBtn");e&&(e.disabled=!1),n=setInterval(()=>{var c;((c=o.ws)==null?void 0:c.readyState)===WebSocket.OPEN&&o.ws.send(JSON.stringify({type:"ping"}))},2e4)},o.ws.onmessage=async e=>{let c;try{c=JSON.parse(e.data)}catch{console.warn("Message non JSON :",e.data);return}const{type:r,from:a,to:s}=c;if(r==="pos"){M(c);return}if(!(s&&s!==o.localPseudo))switch(r){case"join":a&&v(a);break;case"offer":a&&c.payload&&k(a,c.payload);break;case"answer":a&&c.payload&&N(a,c.payload);break;case"candidate":a&&c.payload&&A(a,c.payload);break;default:console.warn("Type de message inconnu :",r)}},o.ws.onclose=()=>{console.log("Déconnecté du serveur WebSocket."),o.connected=!1,clearInterval(n)},o.ws.onerror=e=>{console.error("Erreur WebSocket :",e)}}function d(t){o.ws&&o.connected&&o.ws.send(JSON.stringify(t))}window.store=o;const g=document.getElementById("pseudo"),w=document.getElementById("connectBtn"),b=document.getElementById("startAudioBtn");w.onclick=()=>{var e;const t=g.value.trim();if(!t){alert("Veuillez saisir votre pseudo (le même que Minecraft).");return}o.localPseudo=t;const n=new AudioContext;(e=o.audioContext)==null||e.valueOf,o.audioContext=n,E("wss://"+window.location.host+"/ws"),setTimeout(()=>{d({type:"join",from:o.localPseudo,to:null,payload:{}})},500),w.disabled=!0,g.disabled=!0};b.onclick=async()=>{try{o.localStream=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1}),console.log("Micro capturé."),Object.keys(o.peers).forEach(t=>{const n=o.peers[t];o.localStream.getTracks().forEach(e=>{n.addTrack(e,o.localStream)})}),Object.keys(o.peers).forEach(t=>{const n=o.peers[t];n.createOffer().then(e=>n.setLocalDescription(e)).then(()=>{n.localDescription&&d({type:"offer",from:o.localPseudo,to:t,payload:n.localDescription})}).catch(console.error)}),b.disabled=!0}catch(t){console.error("Erreur getUserMedia :",t),alert("Impossible d'accéder au micro.")}};
